stages:
  - lint
  - test
  - release
  - snapcraft

lint:
  image: golangci/golangci-lint:latest
  stage: lint
  script:
    - make dependencies
    - make lint

test:
  image: golang:latest
  stage: test
  script:
    - make dependencies
    - make test

release:
  image: golang:latest
  stage: release
  only:
    - tags
  variables:
    GIT_DEPTH: 0
  script:
    - make release

snapcraft:
  image: ubuntu:18.04
  stage: snapcraft
  script:
    - apt-get update -qy
    - apt-get install -y make git wget tar snapcraft 
    - wget "https://dl.google.com/go/go1.14.2.linux-amd64.tar.gz"
    - tar -C /usr/local -xzf go1.14.2.linux-amd64.tar.gz
    - export PATH=$PATH:/usr/local/go/bin:~/go/bin
    - make dependencies
    - make lib
    - echo $SNAPCRAFT_LOGIN_FILE | base64 --decode > snapcraft.login
    - snapcraft login --with snapcraft.login
    - rm -f snapcraft.login *.snap
    - snapcraft
    - snapcraft push --release=stable *.snap
